# YHapLZ

**Y-chromosome Haplogroup Classifier for Low-density SNP Data with PLINK Compatibility**

[![License: GPL-3.0](https://img.shields.io/badge/License-GPL%203.0-blue.svg)](https://opensource.org/licenses/GPL-3.0)
[![Python 3.6+](https://img.shields.io/badge/python-3.6+-blue.svg)](https://www.python.org/downloads/)

## Overview

YHapLZ is a robust Y-chromosome haplogroup classification tool specifically designed to work with **low-density SNP array data** where existing tools fail. It features automatic detection of PLINK diploid VCF format and flexible heterozygosity handling.

### Key Features

- ✅ **Works on SNP chip data** - The only tool that correctly classifies haplogroups from low-density SNP arrays
- ✅ **PLINK compatible** - Automatically handles diploid format VCF (0/0, 0/1, 1/1) output by PLINK
- ✅ **Chromosome ID flexible** - Supports Y, chrY, 24, chr24
- ✅ **Three heterozygosity modes** - strict, moderate (default), lenient
- ✅ **Updated tree** - Based on ISOGG Y-DNA Haplogroup Tree 2019-2020
- ✅ **Ancestor chain validation** - Detects and reports conflicting paths
- ✅ **Downstream inference** - Can infer upstream haplogroups from downstream evidence

### Why YHapLZ?

| Tool | WGS Data | SNP Chip Data | PLINK Format |
|------|----------|---------------|--------------|
| yhaplo | ✓ | ✗ Fails (BT only) | ✗ |
| Y-LineageTracker | ✓ | ✗ Misclassifies | ✗ |
| **YHapLZ** | **✓** | **✓** | **✓** |

In our validation with 558 Tibetan samples (20,279 Y-SNPs from SNP array):
- **YHapLZ**: Correctly identified 68.5% D haplogroup (consistent with literature)
- **yhaplo**: 100% classified only to BT root (complete failure)
- **Y-LineageTracker**: 99.7% D samples misclassified as European I1a2

## Installation

### Requirements

- Python 3.6+
- No external dependencies (uses only standard library)

### Download

```bash
git clone https://github.com/LakeSZW/YHapLZ.git
cd YHapLZ
```

## Quick Start

```bash
python YHapLZ.py -v input.vcf -i indexdata.csv -o output_dir/
```

### Arguments

| Argument | Required | Description |
|----------|----------|-------------|
| `-v, --vcf` | Yes | Input VCF file (supports .vcf and .vcf.gz) |
| `-i, --isogg` | Yes | ISOGG SNP index file (indexdata.csv) |
| `-o, --output` | Yes | Output directory |
| `--het-mode` | No | Heterozygosity handling: `strict`, `moderate` (default), `lenient` |

### Heterozygosity Modes

| Mode | Description | Use Case |
|------|-------------|----------|
| `strict` | Treat heterozygous as missing | High-quality WGS data |
| `moderate` | Treat heterozygous as derived, but mark | General use (default) |
| `lenient` | Fully treat heterozygous as derived | Low-quality data, maximize classification |

### Example

```bash
# Basic usage
python YHapLZ.py -v sample.vcf -i indexdata.csv -o results/

# With strict heterozygosity handling
python YHapLZ.py -v sample.vcf -i indexdata.csv -o results/ --het-mode strict

# Gzipped VCF
python YHapLZ.py -v sample.vcf.gz -i indexdata.csv -o results/
```

## Output Files

| File | Description |
|------|-------------|
| `YHapLZ_result.txt` | Main results with haplogroup assignments |
| `YHapLZ_summary.txt` | Summary statistics |

### Result Columns

| Column | Description |
|--------|-------------|
| Sample | Sample ID |
| Main_Branch | Major haplogroup branch (e.g., D, O, R) |
| Haplogroup | Full haplogroup classification |
| Confidence | Classification confidence (0-1) |
| N_SNPs | Number of derived SNPs supporting classification |
| Het_Count | Number of heterozygous sites (QC metric) |
| Main_Status | How main branch was determined |
| Evidence | Supporting SNP markers |
| Conflicts | Any conflicting markers in ancestor chain |

## Building YHapLZ from Source

YHapLZ is generated by integrating haplogroup tree files into the base classifier. This section explains how to build it yourself or update the tree.

### Prerequisites

1. **Base classifier**: `proYHapLZ.py` - Contains the classification algorithm
2. **Tree files**: `ATREE.txt`, `BTREE.txt`, ... `TTREE.txt` - Haplogroup tree definitions
3. **Generator script**: `generate_YHapLZ.py` - Combines everything into `YHapLZ.py`
4. **SNP index**: `indexdata.csv` - SNP position and allele information

### Obtaining Tree Files from ISOGG

The tree files are derived from the [ISOGG Y-DNA Haplogroup Tree 2019-2020](https://isogg.org/tree/).

**Steps for each haplogroup (using A as example):**

1. Go to ISOGG website: [Y-DNA Haplogroup Tree 2019-2020 (for China users)](https://isogg.org/tree/)

2. Download the Excel file for haplogroup A: `2019HaplogroupA.xlsx`

3. Open in Excel and:
   - Delete all content not related to the tree structure
   - Remove the instruction line: `"THE TREE MOVES FAR RIGHT. WIDEN YOUR WINDOW."`
   - Keep only the haplogroup names and their defining SNPs

4. Save as tab-delimited text file: `ATREE.txt`

5. Repeat for all haplogroups: B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T

### Tree File Format

Each tree file should be tab-indented with haplogroup name and defining SNP:

```
A	L1085
	A0	CTS2809.1
		A0a	L979
			A0a1	L1070
				A0a1a	P114
```

The number of leading tabs indicates the hierarchical level.

### Generating YHapLZ.py

```bash
# Ensure all files are in the same directory
ls proYHapLZ.py generate_YHapLZ.py ATREE.txt BTREE.txt ... TTREE.txt

# Run generator
python generate_YHapLZ.py

# Output
# ============================================================
# YHapLZ Generator
# Integrating A-T complete haplogroup trees
# ============================================================
# 
# Parsing tree files...
#   A: 245 nodes
#   B: 189 nodes
#   ...
# 
# Generation complete!
#   Output: YHapLZ.py
#   Total haplogroup branches: 20
#   Total tree nodes: 4254
```

### File Structure

```
YHapLZ/
├── YHapLZ.py              # Main classifier (generated)
├── proYHapLZ.py           # Base classifier code
├── generate_YHapLZ.py     # Generator script
├── indexdata.csv          # ISOGG SNP index
├── ATREE.txt              # Haplogroup A tree
├── BTREE.txt              # Haplogroup B tree
├── ...
├── TTREE.txt              # Haplogroup T tree
└── README.md
```

## Validation

### 1000 Genomes Project (n=1,233)

| Metric | Value |
|--------|-------|
| Concordance with gold standard | 99.3% (99.84% after correction) |
| Deeper resolution than published | 74.3% |
| Same resolution | 22.2% |

### Robustness (SNP Downsampling)

| SNP Retention | YHapLZ | yhaplo | Y-LineageTracker |
|---------------|--------|--------|------------------|
| 100% | 100.0% | 100.0% | 100.0% |
| 50% | 100.0% | 100.0% | 99.4% |
| 25% | 94.9% | 100.0% | 89.7% |
| 10% | 97.3% | 97.1% | 51.7% |
| 5% | 87.4% | 96.8% | 29.5% |
| 2% | 96.8% | 90.8% | 7.6% |

### Tibetan SNP Chip Data (n=558, 20,279 Y-SNPs)

| Haplogroup | YHapLZ | Y-LineageTracker | yhaplo | Expected |
|------------|--------|------------------|--------|----------|
| D | 68.5% | 0% | 0% | 40-70% ✓ |
| I | 0% | 74.2% | 0% | <1% |
| BT (root) | 0% | 0% | 100% | N/A |
| O | 19.0% | 19.0% | 0% | 15-25% |

## PLINK Format Compatibility

PLINK outputs Y-chromosome genotypes in diploid format by default:

```
# Standard VCF (haploid Y)
Y  2787050  .  C  A  .  .  .  GT  1

# PLINK output (diploid format)
Y  2787050  .  C  A  .  .  .  GT  0/1
```

YHapLZ automatically detects and correctly parses both formats:

| Genotype | Format | YHapLZ Interpretation |
|----------|--------|----------------------|
| `1` | haploid | Derived |
| `0` | haploid | Ancestral |
| `1/1` | diploid | Derived |
| `0/0` | diploid | Ancestral |
| `0/1` | diploid | Heterozygous (handled by het-mode) |

## Algorithm

YHapLZ simulates manual haplogroup classification:

1. **Collect derived SNPs**: Scan VCF for all positions matching ISOGG database
2. **Group by main branch**: Organize candidates by major haplogroup (A, B, C, D, ...)
3. **Determine main branch**: 
   - First: Check if defining SNP is derived
   - Second: Infer from downstream evidence if defining SNP missing
4. **Subdivide with validation**: 
   - Sort candidates by depth and SNP count
   - Validate ancestor chain consistency
   - Select deepest validated node
5. **Calculate confidence**: Based on evidence strength and conflicts

## Citation

If you use YHapLZ in your research, please cite:

```
[Citation will be added after publication]
```

## License

This project is licensed under the GPL-3.0 License - see the [LICENSE](LICENSE) file for details.


## Acknowledgments

- ISOGG for maintaining the Y-DNA Haplogroup Tree
- 1000 Genomes Project for validation data
- Poznik et al. (2016) for gold standard haplogroup assignments
- Chen et al. (2021) for Y-LineageTracker comparison data

